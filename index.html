<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caderno de Avaliação - Gestor de Tarefas</title>
    
    <!-- Tailwind CSS para um design rápido e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts para uma tipografia mais agradável -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados e para a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        /* Esconde o scrollbar mas permite fazer scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Estrutura principal da aplicação -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Cabeçalho -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <h1 id="app-header-title" class="text-xl sm:text-2xl font-bold text-slate-900 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 inline-block -mt-1 mr-2 text-blue-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
                    </svg>
                    <span id="app-title-text">Caderno de Avaliação</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="add-class-btn" class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-0 sm:mr-2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span id="btn-new-class-text">Nova Turma</span>
                    </button>
                    <div id="language-switcher" class="flex space-x-2"></div>
                </div>
            </div>
        </header>

        <!-- Conteúdo principal -->
        <main class="flex-grow max-w-5xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <aside id="sidebar" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"></aside>
                <section id="task-panel" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md min-h-[400px]"></section>
            </div>
            <div id="welcome-screen" class="text-center p-10 bg-white rounded-xl shadow-md hidden"></div>
        </main>
    </div>

    <!-- Modals (janelas pop-up) -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <script type="module">
        // ===================================================================================
        // I18N - INTERNACIONALIZAÇÃO E TRADUÇÕES
        // ===================================================================================
        const translations = {
            pt: {
                app_title: "Caderno de Avaliação", new_class: "Nova Turma", welcome_title: "Bem-vindo ao Caderno de Avaliação!", welcome_subtitle: "A sua ferramenta para gerir as avaliações da turma.", welcome_button: "Comece por criar a sua primeira turma", active_class: "Turma Ativa", delete_class_title: "Eliminar turma", students_title: "Alunos", no_students: "Ainda não há alunos nesta turma.", add_student: "Adicionar", import_students: "Importar", task_management: "Gestão de Avaliações", new_task: "Nova Avaliação", select_class_prompt: "Selecione uma turma para ver as avaliações.", active_task: "Avaliação Ativa", delete_task_title: "Eliminar avaliação", progress: "Progresso", no_tasks_found: "Nenhuma avaliação encontrada", no_tasks_prompt: "Crie a sua primeira avaliação para esta turma.", create_new_class: "Criar Nova Turma", class_name: "Nome da Turma", class_name_placeholder: "Ex: 5ºB", cancel: "Cancelar", create: "Criar", add_new_student: "Adicionar Novo Aluno", student_name: "Nome do Aluno", student_name_placeholder: "Ex: Ana Silva", import_students_title: "Importar Alunos", import_students_prompt: "Cole a lista de alunos abaixo, com um nome por linha.", import_students_placeholder: "Ana Silva\nBruno Costa\nCarla Mendes\n...", create_new_task: "Criar Nova Avaliação", task_name: "Nome da Avaliação", task_name_placeholder: "Ex: Teste de Matemática", task_date: "Data", attention: "Atenção", delete: "Eliminar",
                confirm_delete: (item) => `Tem a certeza que quer eliminar "${item}"?`,
                reports: "Relatórios", class_report: "Relatório da Turma", student_report: "Relatório do Aluno", view_report: "Ver relatório", print_report: "Imprimir Relatório", task: "Avaliação", status: "Estado", completed: "Concluído", not_completed: "Não Concluído", tasks_completed: "Tarefas Concluídas",
                selectAll: "Marcar Todos", deselectAll: "Desmarcar Todos", task_weight: "Peso (1-5)", weighted_score: "Pontuação Ponderada", weighted_average: "Média Ponderada", weight_abbr: "P",
                app_data: "Dados da Aplicação", export_data: "Exportar Dados", import_data: "Importar Dados", import_confirm_title: "Confirmar Importação", import_confirm_message: "Isto irá substituir todos os seus dados atuais. Tem a certeza que quer continuar?", import_error: "Erro ao importar. Verifique se o ficheiro é um backup válido.", confirm: "Confirmar",
                task_bank: "Banco de Avaliações", manage_bank: "Gerir", choose_from_bank: "Escolher do Banco", manage_task_bank: "Gerir Banco de Avaliações", add_template: "Adicionar Modelo", new_template: "Novo Modelo de Avaliação", template_name: "Nome do Modelo", save: "Guardar",
                evaluation_type: "Tipo de Avaliação", completion_based: "Concluído / Não Concluído", grade_based: "Nota Numérica", max_grade: "Nota Máxima", grade: "Nota",
            },
            en: {
                app_title: "Gradebook", new_class: "New Class", welcome_title: "Welcome to the Gradebook!", welcome_subtitle: "Your tool to manage class assessments.", welcome_button: "Start by creating your first class", active_class: "Active Class", delete_class_title: "Delete class", students_title: "Students", no_students: "There are no students in this class yet.", add_student: "Add", import_students: "Import", task_management: "Assessment Management", new_task: "New Assessment", select_class_prompt: "Select a class to see the assessments.", active_task: "Active Assessment", delete_task_title: "Delete assessment", progress: "Progress", no_tasks_found: "No assessments found", no_tasks_prompt: "Create your first assessment for this class.", create_new_class: "Create New Class", class_name: "Class Name", class_name_placeholder: "Ex: 5th Grade B", cancel: "Cancel", create: "Create", add_new_student: "Add New Student", student_name: "Student Name", student_name_placeholder: "Ex: John Smith", import_students_title: "Import Students", import_students_prompt: "Paste the student list below, one name per line.", import_students_placeholder: "John Smith\nJane Doe\nPeter Jones\n...", create_new_task: "Create New Assessment", task_name: "Assessment Name", task_name_placeholder: "Ex: Math Test", task_date: "Date", attention: "Warning", delete: "Delete",
                confirm_delete: (item) => `Are you sure you want to delete "${item}"?`,
                reports: "Reports", class_report: "Class Report", student_report: "Student Report", view_report: "View report", print_report: "Print Report", task: "Assessment", status: "Status", completed: "Completed", not_completed: "Not Completed", tasks_completed: "Tasks Completed",
                selectAll: "Select All", deselectAll: "Deselect All", task_weight: "Weight (1-5)", weighted_score: "Weighted Score", weighted_average: "Weighted Average", weight_abbr: "W",
                app_data: "Application Data", export_data: "Export Data", import_data: "Import Data", import_confirm_title: "Confirm Import", import_confirm_message: "This will overwrite all your current data. Are you sure you want to continue?", import_error: "Error on import. Please check if the file is a valid backup.", confirm: "Confirm",
                task_bank: "Assessment Bank", manage_bank: "Manage", choose_from_bank: "Choose from Bank", manage_task_bank: "Manage Assessment Bank", add_template: "Add Template", new_template: "New Assessment Template", template_name: "Template Name", save: "Save",
                evaluation_type: "Evaluation Type", completion_based: "Completed / Not Completed", grade_based: "Numerical Grade", max_grade: "Max Grade", grade: "Grade",
            },
            es: {
                app_title: "Cuaderno de Evaluación", new_class: "Nueva Clase", welcome_title: "¡Bienvenido al Cuaderno de Evaluación!", welcome_subtitle: "Tu herramienta para gestionar las evaluaciones de la clase.", welcome_button: "Empieza creando tu primera clase", active_class: "Clase Activa", delete_class_title: "Eliminar clase", students_title: "Alumnos", no_students: "Aún no hay alumnos en esta clase.", add_student: "Añadir", import_students: "Importar", task_management: "Gestión de Evaluaciones", new_task: "Nueva Evaluación", select_class_prompt: "Selecciona una clase para ver las evaluaciones.", active_task: "Evaluación Activa", delete_task_title: "Eliminar evaluación", progress: "Progreso", no_tasks_found: "No se encontraron evaluaciones", no_tasks_prompt: "Crea tu primera evaluación para esta clase.", create_new_class: "Crear Nueva Clase", class_name: "Nombre de la Clase", class_name_placeholder: "Ej: 5ºB", cancel: "Cancelar", create: "Crear", add_new_student: "Añadir Nuevo Alumno", student_name: "Nombre del Alumno", student_name_placeholder: "Ej: Ana García", import_students_title: "Importar Alumnos", import_students_prompt: "Pega la lista de alumnos abajo, un nombre por línea.", import_students_placeholder: "Ana García\nCarlos Pérez\nLaura Gómez\n...", create_new_task: "Crear Nueva Evaluación", task_name: "Nombre de la Evaluación", task_name_placeholder: "Ej: Examen de Matemáticas", task_date: "Fecha", attention: "Atención", delete: "Eliminar",
                confirm_delete: (item) => `¿Estás seguro de que quieres eliminar "${item}"?`,
                reports: "Informes", class_report: "Informe de la Clase", student_report: "Informe del Alumno", view_report: "Ver informe", print_report: "Imprimir Informe", task: "Evaluación", status: "Estado", completed: "Completado", not_completed: "No Completado", tasks_completed: "Tareas Completadas",
                selectAll: "Marcar Todos", deselectAll: "Desmarcar Todos", task_weight: "Peso (1-5)", weighted_score: "Puntuación Ponderada", weighted_average: "Promedio Ponderado", weight_abbr: "P",
                app_data: "Datos de la Aplicación", export_data: "Exportar Datos", import_data: "Importar Datos", import_confirm_title: "Confirmar Importación", import_confirm_message: "Esto reemplazará todos sus datos actuales. ¿Está seguro de que desea continuar?", import_error: "Error al importar. Verifique que el archivo sea una copia de seguridad válida.", confirm: "Confirmar",
                task_bank: "Banco de Evaluaciones", manage_bank: "Gestionar", choose_from_bank: "Elegir del Banco", manage_task_bank: "Gestionar Banco de Evaluaciones", add_template: "Añadir Plantilla", new_template: "Nueva Plantilla de Evaluación", template_name: "Nombre de Plantilla", save: "Guardar",
                evaluation_type: "Tipo de Evaluación", completion_based: "Completado / No Completado", grade_based: "Nota Numérica", max_grade: "Nota Máxima", grade: "Nota",
            }
        };
        const t = (key, ...args) => { const tr = translations[state.language]?.[key]; return typeof tr === 'function' ? tr(...args) : tr || key; };

        // ===================================================================================
        // ESTADO DA APLICAÇÃO E LIGAÇÃO AO NAVEGADOR (LOCALSTORAGE)
        // ===================================================================================
        let state = { classes: [], taskBank: [], activeClassId: null, activeTaskId: null, language: 'pt' };
        const saveState = () => localStorage.setItem('apontadorState', JSON.stringify(state));
        const loadState = () => {
            const savedState = localStorage.getItem('apontadorState');
            if (savedState) { 
                state = JSON.parse(savedState);
                if (!state.taskBank) state.taskBank = [];
            }
            if (!state.language) {
                const userLang = navigator.language || navigator.userLanguage;
                if (userLang.startsWith('es')) state.language = 'es';
                else if (userLang.startsWith('en')) state.language = 'en';
                else state.language = 'pt';
            }
            if (state.taskBank.length === 0) {
                state.taskBank = [
                    { id: crypto.randomUUID(), name: "TPC", weight: 1, type: 'completion' },
                    { id: crypto.randomUUID(), name: "Participação", weight: 2, type: 'completion' },
                    { id: crypto.randomUUID(), name: "Apresentação", weight: 3, type: 'grade', maxGrade: 20 },
                    { id: crypto.randomUUID(), name: "Trabalho de Grupo", weight: 4, type: 'grade', maxGrade: 20 },
                    { id: crypto.randomUUID(), name: "Teste", weight: 5, type: 'grade', maxGrade: 20 },
                ];
            }
        };

        // ===================================================================================
        // LÓGICA DE MANIPULAÇÃO DE DADOS
        // ===================================================================================
        const addClass = (name) => { const newClass = { id: crypto.randomUUID(), name, students: [], tasks: [] }; state.classes.push(newClass); state.activeClassId = newClass.id; saveState(); render(); };
        const addStudent = (name) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; const newStudent = { id: crypto.randomUUID(), name }; activeClass.students.push(newStudent); activeClass.tasks.forEach(task => task.results[newStudent.id] = null); saveState(); render(); };
        const importStudents = (text) => { const names = text.split('\n').map(n => n.trim()).filter(Boolean); if (!names.length) return; const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; names.forEach(name => { const newStudent = { id: crypto.randomUUID(), name }; activeClass.students.push(newStudent); activeClass.tasks.forEach(task => task.results[newStudent.id] = null); }); saveState(); render(); };
        const addTask = (taskData) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; const results = {}; activeClass.students.forEach(s => { results[s.id] = null; }); const newTask = { id: crypto.randomUUID(), ...taskData, results }; activeClass.tasks.push(newTask); activeClass.tasks.sort((a, b) => new Date(b.date) - new Date(a.date)); state.activeTaskId = newTask.id; saveState(); render(); };
        const updateTaskResult = (studentId, result) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); const activeTask = activeClass?.tasks.find(t => t.id === state.activeTaskId); if (!activeTask) return; activeTask.results[studentId] = result; saveState(); render(); };
        const setAllTasksStatus = (status) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); const activeTask = activeClass?.tasks.find(t => t.id === state.activeTaskId); if (!activeTask || activeTask.type !== 'completion') return; activeClass.students.forEach(student => { activeTask.results[student.id] = status; }); saveState(); render(); };
        const deleteClass = (id) => { state.classes = state.classes.filter(c => c.id !== id); if (state.activeClassId === id) { state.activeClassId = state.classes.length > 0 ? state.classes[0].id : null; state.activeTaskId = null; } saveState(); render(); };
        const deleteStudent = (id) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; activeClass.students = activeClass.students.filter(s => s.id !== id); activeClass.tasks.forEach(task => { delete task.results[id]; }); saveState(); render(); };
        const deleteTask = (id) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; activeClass.tasks = activeClass.tasks.filter(t => t.id !== id); if (state.activeTaskId === id) { state.activeTaskId = activeClass.tasks.length > 0 ? activeClass.tasks[0].id : null; } saveState(); render(); };
        const calculateWeightedScore = (studentId, tasks) => { let totalWeight = 0; let achievedWeight = 0; tasks.forEach(task => { const weight = task.weight || 1; totalWeight += weight; const result = task.results[studentId]; if (task.type === 'completion' && result === true) { achievedWeight += weight; } else if (task.type === 'grade' && typeof result === 'number') { const maxGrade = task.maxGrade || 20; achievedWeight += (result / maxGrade) * weight; } }); return totalWeight > 0 ? ((achievedWeight / totalWeight) * 100).toFixed(0) : 0; };
        const exportData = () => { const dataStr = JSON.stringify(state, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); const date = new Date().toISOString().split('T')[0]; link.download = `caderno-avaliacao-backup-${date}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); };
        const importData = (file) => { const reader = new FileReader(); reader.onload = (e) => { try { const importedState = JSON.parse(e.target.result); if (importedState && Array.isArray(importedState.classes)) { showConfirmationModal(t('import_confirm_message'), () => { state = importedState; if (!state.taskBank) state.taskBank = []; saveState(); render(); }, t('import_confirm_title')); } else { throw new Error("Invalid file structure"); } } catch (error) { showErrorModal(t('import_error')); } }; reader.readAsText(file); };
        const addTaskTemplate = (templateData) => { state.taskBank.push({ id: crypto.randomUUID(), ...templateData }); saveState(); renderManageTaskBankModal(); };
        const deleteTaskTemplate = (id) => { state.taskBank = state.taskBank.filter(t => t.id !== id); saveState(); renderManageTaskBankModal(); };

        // ===================================================================================
        // FUNÇÕES DE RENDERIZAÇÃO
        // ===================================================================================
        const formatDate = (dateString) => { if (!dateString) return ''; const date = new Date(dateString); return new Intl.DateTimeFormat(state.language).format(date); };
        const render = () => { document.documentElement.lang = state.language; renderHeader(); if (state.classes.length === 0) { document.getElementById('main-content').style.display = 'none'; document.getElementById('welcome-screen').style.display = 'block'; renderWelcomeScreen(); } else { document.getElementById('main-content').style.display = 'grid'; document.getElementById('welcome-screen').style.display = 'none'; renderSidebar(); renderTaskPanel(); } };
        const renderHeader = () => { document.title = t('app_title'); document.getElementById('app-title-text').textContent = t('app_title'); document.getElementById('btn-new-class-text').textContent = t('new_class'); const langContainer = document.getElementById('language-switcher'); langContainer.innerHTML = ['pt', 'en', 'es'].map(lang => `<button data-lang="${lang}" class="lang-btn p-0.5 border-2 ${state.language === lang ? 'border-blue-500' : 'border-transparent'} rounded-full transition-all"><img src="https://flagcdn.com/w20/${lang === 'en' ? 'gb' : lang}.png" srcset="https://flagcdn.com/w40/${lang === 'en' ? 'gb' : lang}.png 2x" width="20" alt="${lang.toUpperCase()}"></button>`).join(''); langContainer.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => { state.language = e.currentTarget.dataset.lang; saveState(); render(); })); };
        const renderWelcomeScreen = () => { const container = document.getElementById('welcome-screen'); container.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-blue-500 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg><h2 class="text-2xl font-bold mb-2">${t('welcome_title')}</h2><p class="text-slate-600 mb-6">${t('welcome_subtitle')}</p><button id="welcome-add-class-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-blue-700 transition-colors text-lg">${t('welcome_button')}</button>`; document.getElementById('welcome-add-class-btn').addEventListener('click', showAddClassModal); };
        const renderSidebar = () => { const container = document.getElementById('sidebar'); const activeClass = state.classes.find(c => c.id === state.activeClassId); container.innerHTML = `<div><label for="class-select" class="block text-sm font-medium text-slate-700 mb-1">${t('active_class')}</label><div class="flex items-center space-x-2"><select id="class-select" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">${state.classes.map(c => `<option value="${c.id}" ${c.id === state.activeClassId ? 'selected' : ''}>${c.name}</option>`).join('')}</select><button id="delete-class-btn" title="${t('delete_class_title')}" class="p-2.5 text-slate-500 hover:text-red-600 hover:bg-red-100 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div></div><div class="mt-6"><h3 class="font-semibold text-lg mb-3">${t('students_title')} (${activeClass?.students.length || 0})</h3><div class="max-h-60 overflow-y-auto no-scrollbar pr-2 space-y-2 mb-4">${activeClass && activeClass.students.length > 0 ? activeClass.students.map(s => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-md"><span class="text-slate-700">${s.name}</span><div class="flex items-center"><button data-student-id="${s.id}" title="${t('view_report')}" class="view-student-report-btn p-1 text-slate-400 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3.75h16.5M3.75 12h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M16.5 3.75v16.5" /></svg></button><button data-student-id="${s.id}" class="delete-student-btn p-1 text-slate-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button></div></div>`).join('') : `<p class="text-slate-500 text-sm">${t('no_students')}</p>`}</div><div class="grid grid-cols-2 gap-2"><button id="add-student-btn" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center text-sm"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3.375 19.5h17.25a2.25 2.25 0 0 0 2.25-2.25V6.75a2.25 2.25 0 0 0-2.25-2.25H3.375A2.25 2.25 0 0 0 1.125 6.75v10.5a2.25 2.25 0 0 0 2.25 2.25Z" /></svg>${t('add_student')}</button><button id="import-students-btn" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center text-sm"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>${t('import_students')}</button></div></div><div class="mt-6 border-t pt-6"><h3 class="font-semibold text-lg mb-3">${t('task_bank')}</h3><button id="manage-task-bank-btn" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center text-sm">${t('manage_bank')}</button></div><div class="mt-6 border-t pt-6"><h3 class="font-semibold text-lg mb-3">${t('app_data')}</h3><div class="grid grid-cols-2 gap-2"><button id="export-data-btn" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center text-sm">${t('export_data')}</button><button id="import-data-btn" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center text-sm">${t('import_data')}</button></div></div>`; document.getElementById('class-select').addEventListener('change', (e) => { state.activeClassId = e.target.value; const newActiveClass = state.classes.find(c => c.id === state.activeClassId); state.activeTaskId = newActiveClass && newActiveClass.tasks.length > 0 ? newActiveClass.tasks[0].id : null; saveState(); render(); }); document.getElementById('delete-class-btn').addEventListener('click', () => { showConfirmationModal(t('confirm_delete', activeClass.name), () => deleteClass(state.activeClassId)); }); document.getElementById('add-student-btn').addEventListener('click', showAddStudentModal); document.getElementById('import-students-btn').addEventListener('click', showImportStudentsModal); document.querySelectorAll('.delete-student-btn').forEach(btn => { btn.addEventListener('click', (e) => { const studentId = e.currentTarget.dataset.studentId; const student = activeClass.students.find(s => s.id === studentId); showConfirmationModal(t('confirm_delete', student.name), () => deleteStudent(studentId)); }); }); document.querySelectorAll('.view-student-report-btn').forEach(btn => { btn.addEventListener('click', (e) => { showStudentReportModal(e.currentTarget.dataset.studentId); }); }); document.getElementById('export-data-btn').addEventListener('click', exportData); document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click()); document.getElementById('manage-task-bank-btn').addEventListener('click', showManageTaskBankModal);};
        const renderTaskPanel = () => { const container = document.getElementById('task-panel'); const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) { container.innerHTML = `<p class="text-slate-500 text-center mt-10">${t('select_class_prompt')}</p>`; return; } activeClass.tasks.sort((a, b) => new Date(b.date) - new Date(a.date)); const activeTask = activeClass.tasks.find(t => t.id === state.activeTaskId); container.innerHTML = `<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"><div class="flex-grow"><h2 class="text-2xl font-bold">${activeClass.name}</h2><p class="text-slate-500">${t('task_management')}</p></div><div class="flex space-x-2 mt-4 sm:mt-0"><button id="class-report-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors flex items-center text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3.75h16.5M3.75 12h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M16.5 3.75v16.5" /></svg>${t('reports')}</button><button id="add-task-btn" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors flex items-center text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>${t('new_task')}</button></div></div>${activeClass.tasks.length > 0 ? `<div class="mb-6"><label for="task-select" class="block text-sm font-medium text-slate-700 mb-1">${t('active_task')}</label><div class="flex items-center space-x-2"><select id="task-select" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">${activeClass.tasks.map(task => `<option value="${task.id}" ${task.id === state.activeTaskId ? 'selected' : ''}>(${t('weight_abbr')}:${task.weight || 1}) ${formatDate(task.date)} - ${task.name}</option>`).join('')}</select><button id="delete-task-btn" title="${t('delete_task_title')}" class="p-2.5 text-slate-500 hover:text-red-600 hover:bg-red-100 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div></div><div id="task-interface-container" class="space-y-3 max-h-[50vh] overflow-y-auto no-scrollbar pr-2"></div>` : `<div class="text-center py-10"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto text-slate-400 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><h3 class="text-xl font-semibold">${t('no_tasks_found')}</h3><p class="text-slate-500 mt-1">${t('no_tasks_prompt')}</p></div>`}`; if (activeClass.tasks.length > 0) { renderTaskInterface(activeTask); document.getElementById('task-select').addEventListener('change', (e) => { state.activeTaskId = e.target.value; saveState(); render(); }); document.getElementById('delete-task-btn').addEventListener('click', () => { const taskToDelete = activeClass.tasks.find(t => t.id === state.activeTaskId); showConfirmationModal(t('confirm_delete', taskToDelete.name), () => deleteTask(state.activeTaskId)); }); } document.getElementById('add-task-btn').addEventListener('click', showAddTaskModal); document.getElementById('class-report-btn')?.addEventListener('click', showClassReportModal); };
        const renderTaskInterface = (activeTask) => { const container = document.getElementById('task-interface-container'); if (!activeTask) { container.innerHTML = ''; return; } const activeClass = state.classes.find(c => c.id === state.activeClassId); if (activeTask.type === 'grade') { const completedCount = Object.values(activeTask.results).filter(r => typeof r === 'number').length; container.innerHTML = `<div class="mb-2"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-slate-600">${t('progress')}</span><span class="text-sm font-bold text-slate-800">${completedCount} / ${activeClass.students.length}</span></div><div class="w-full bg-slate-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${activeClass.students.length > 0 ? (completedCount / activeClass.students.length) * 100 : 0}%"></div></div></div>${activeClass.students.map(student => `<div class="flex items-center justify-between p-3 rounded-lg bg-slate-100"><span>${student.name}</span><div class="flex items-center space-x-2"><input type="number" min="0" max="${activeTask.maxGrade}" data-student-id="${student.id}" value="${activeTask.results[student.id] || ''}" class="grade-input w-20 text-center bg-white border border-slate-300 rounded-md p-1"><span>/ ${activeTask.maxGrade}</span></div></div>`).join('')}`; document.querySelectorAll('.grade-input').forEach(input => { input.addEventListener('change', (e) => { const studentId = e.target.dataset.studentId; let value = e.target.value === '' ? null : parseFloat(e.target.value); if (value !== null && (value < 0 || value > activeTask.maxGrade)) { value = Math.max(0, Math.min(value, activeTask.maxGrade)); e.target.value = value; } updateTaskResult(studentId, value); }); }); } else { const completedCount = Object.values(activeTask.results).filter(r => r === true).length; container.innerHTML = `<div class="mb-2"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-slate-600">${t('progress')}</span><span class="text-sm font-bold text-slate-800">${completedCount} / ${activeClass.students.length}</span></div><div class="w-full bg-slate-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${activeClass.students.length > 0 ? (completedCount / activeClass.students.length) * 100 : 0}%"></div></div></div><div class="flex justify-end space-x-2 mb-4"><button id="select-all-btn" class="text-xs font-semibold text-blue-600 hover:underline">${t('selectAll')}</button><button id="deselect-all-btn" class="text-xs font-semibold text-blue-600 hover:underline">${t('deselectAll')}</button></div>${activeClass.students.map(student => { const isDone = activeTask.results[student.id]; return `<div data-student-id="${student.id}" class="task-item flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${isDone ? 'bg-green-100 text-slate-500' : 'bg-slate-100 hover:bg-slate-200'}"><span class="font-medium ${isDone ? 'line-through' : 'text-slate-800'}">${student.name}</span><div class="w-6 h-6 flex items-center justify-center rounded-full border-2 ${isDone ? 'bg-green-500 border-green-500' : 'border-slate-300'}">${isDone ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>` : ''}</div></div>`}).join('')}`; document.querySelectorAll('.task-item').forEach(item => { item.addEventListener('click', (e) => updateTaskResult(e.currentTarget.dataset.studentId, !activeTask.results[e.currentTarget.dataset.studentId])); }); document.getElementById('select-all-btn').addEventListener('click', () => setAllTasksStatus(true)); document.getElementById('deselect-all-btn').addEventListener('click', () => setAllTasksStatus(false)); } };
        
        // ===================================================================================
        // GESTÃO DE MODALS
        // ===================================================================================
        const modalContainer = document.getElementById('modal-container');
        const showModal = (content) => { modalContainer.innerHTML = content; modalContainer.classList.remove('hidden'); const input = modalContainer.querySelector('input, textarea'); if (input) input.focus(); modalContainer.querySelector('.close-modal-btn')?.addEventListener('click', hideModal); modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) hideModal(); }); };
        const hideModal = () => { modalContainer.classList.add('hidden'); modalContainer.innerHTML = ''; };
        const showAddClassModal = () => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('create_new_class')}</h3></div><form id="add-class-form" class="p-6 space-y-4"><div><label for="class-name" class="block text-sm font-medium text-slate-700 mb-1">${t('class_name')}</label><input type="text" id="class-name" placeholder="${t('class_name_placeholder')}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div><div class="flex justify-end space-x-3 pt-4 modal-buttons"><button type="button" class="close-modal-btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">${t('cancel')}</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">${t('create')}</button></div></form></div>`; showModal(content); document.getElementById('add-class-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('class-name').value.trim(); if (name) { addClass(name); hideModal(); } }); };
        const showAddStudentModal = () => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('add_new_student')}</h3></div><form id="add-student-form" class="p-6 space-y-4"><div><label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">${t('student_name')}</label><input type="text" id="student-name" placeholder="${t('student_name_placeholder')}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div><div class="flex justify-end space-x-3 pt-4 modal-buttons"><button type="button" class="close-modal-btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">${t('cancel')}</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">${t('add_student')}</button></div></form></div>`; showModal(content); document.getElementById('add-student-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('student-name').value.trim(); if (name) { addStudent(name); hideModal(); } }); };
        const showImportStudentsModal = () => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('import_students_title')}</h3></div><form id="import-students-form" class="p-6 space-y-4"><div><label for="student-list" class="block text-sm font-medium text-slate-700 mb-2">${t('import_students_prompt')}</label><textarea id="student-list" rows="8" placeholder="${t('import_students_placeholder')}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></textarea></div><div class="flex justify-end space-x-3 pt-4 modal-buttons"><button type="button" class="close-modal-btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">${t('cancel')}</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">${t('import_students')}</button></div></form></div>`; showModal(content); document.getElementById('import-students-form').addEventListener('submit', (e) => { e.preventDefault(); const list = document.getElementById('student-list').value; importStudents(list); hideModal(); }); };
        const showAddTaskModal = (template = {}) => { const today = new Date().toISOString().split('T')[0]; const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">${t('create_new_task')}</h3><button id="choose-from-bank-btn" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200">${t('choose_from_bank')}</button></div><form id="add-task-form" class="p-6 space-y-4"><div><label class="block text-sm font-medium text-slate-700 mb-2">${t('evaluation_type')}</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="task-type" value="completion" ${template.type !== 'grade' ? 'checked' : ''} class="mr-2"> ${t('completion_based')}</label><label class="flex items-center"><input type="radio" name="task-type" value="grade" ${template.type === 'grade' ? 'checked' : ''} class="mr-2"> ${t('grade_based')}</label></div></div><div><label for="task-name" class="block text-sm font-medium text-slate-700 mb-1">${t('task_name')}</label><input type="text" id="task-name" value="${template.name || ''}" placeholder="${t('task_name_placeholder')}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div><div class="grid grid-cols-2 gap-4"><div><label for="task-date" class="block text-sm font-medium text-slate-700 mb-1">${t('task_date')}</label><input type="date" id="task-date" value="${today}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div><div><label for="task-weight" class="block text-sm font-medium text-slate-700 mb-1">${t('task_weight')}</label><input type="number" id="task-weight" value="${template.weight || 1}" min="1" max="5" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div></div><div id="max-grade-container" class="${template.type === 'grade' ? '' : 'hidden'}"><label for="max-grade" class="block text-sm font-medium text-slate-700 mb-1">${t('max_grade')}</label><input type="number" id="max-grade" value="${template.maxGrade || 20}" min="1" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></div><div class="flex justify-end space-x-3 pt-4 modal-buttons"><button type="button" class="close-modal-btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">${t('cancel')}</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">${t('create')}</button></div></form></div>`; showModal(content); document.querySelectorAll('input[name="task-type"]').forEach(radio => radio.addEventListener('change', (e) => { document.getElementById('max-grade-container').classList.toggle('hidden', e.target.value !== 'grade'); })); document.getElementById('choose-from-bank-btn').addEventListener('click', () => showTaskBankModal()); document.getElementById('add-task-form').addEventListener('submit', (e) => { e.preventDefault(); const taskData = { name: document.getElementById('task-name').value.trim(), date: document.getElementById('task-date').value, weight: Number(document.getElementById('task-weight').value), type: document.querySelector('input[name="task-type"]:checked').value, }; if (taskData.type === 'grade') { taskData.maxGrade = Number(document.getElementById('max-grade').value); } if (taskData.name && taskData.date) { addTask(taskData); hideModal(); } }); };
        const showConfirmationModal = (message, onConfirm, title = t('attention'), confirmText = t('delete')) => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6"><div class="flex items-start space-x-4"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg leading-6 font-medium text-gray-900">${title}</h3><div class="mt-2"><p class="text-sm text-gray-500">${message}</p></div></div></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button id="confirm-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">${confirmText}</button><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); document.getElementById('confirm-btn').addEventListener('click', () => { onConfirm(); hideModal(); }); };
        const showErrorModal = (message) => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content"><div class="p-6"><div class="flex items-start space-x-4"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg leading-6 font-medium text-gray-900">${t('attention')}</h3><div class="mt-2"><p class="text-sm text-gray-500">${message}</p></div></div></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); };
        const showStudentReportModal = (studentId) => { const activeClass = state.classes.find(c => c.id === state.activeClassId); const student = activeClass.students.find(s => s.id === studentId); if (!student) return; const tasks = activeClass.tasks; const score = calculateWeightedScore(studentId, tasks); const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('student_report')}: ${student.name}</h3><p class="text-sm text-slate-500">${activeClass.name}</p></div><div class="p-6 space-y-4" id="student-report-content"><div class="text-center mb-4"><p class="text-lg font-medium">${t('weighted_score')}</p><p class="text-4xl font-bold text-blue-600">${score}%</p></div><div class="max-h-80 overflow-y-auto no-scrollbar pr-2 space-y-2"><table class="w-full text-left"><thead><tr class="border-b"><th class="py-2">${t('task_date')}</th><th class="py-2">${t('task')}</th><th class="py-2 text-center">${t('task_weight')}</th><th class="py-2 text-right">${t('status')}</th></tr></thead><tbody>${tasks.map(task => { const result = task.results[studentId]; let statusHtml; if (task.type === 'grade') { statusHtml = typeof result === 'number' ? `${result} / ${task.maxGrade}` : 'N/A'; } else { statusHtml = result ? `<span class="text-green-600 font-semibold">${t('completed')}</span>` : `<span class="text-red-600 font-semibold">${t('not_completed')}</span>`; } return `<tr><td class="py-2 text-slate-500">${formatDate(task.date)}</td><td class="py-2">${task.name}</td><td class="py-2 text-center">${task.weight || 1}</td><td class="py-2 text-right">${statusHtml}</td></tr>`}).join('')}</tbody></table></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button id="print-report-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">${t('print_report')}</button><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); document.getElementById('print-report-btn').addEventListener('click', () => { const reportContent = document.getElementById('student-report-content').innerHTML; const reportTitle = `${t('student_report')}: ${student.name}`; printReport(reportContent, reportTitle); }); };
        const showClassReportModal = () => { const activeClass = state.classes.find(c => c.id === state.activeClassId); if (!activeClass) return; const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('class_report')}: ${activeClass.name}</h3></div><div class="p-6 space-y-4" id="class-report-content"><div class="max-h-[70vh] overflow-auto"><table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="py-2 sticky top-0 bg-white">${t('student_name')}</th>${activeClass.tasks.map(task => `<th class="py-2 text-center sticky top-0 bg-white" title="${task.name}">${formatDate(task.date)}<br><span class="font-normal text-xs">(${t('weight_abbr')}:${task.weight || 1})</span></th>`).join('')}<th class="py-2 text-center sticky top-0 bg-white font-bold">${t('weighted_average')}</th></tr></thead><tbody>${activeClass.students.map(student => { const score = calculateWeightedScore(student.id, activeClass.tasks); return `<tr><td class="py-2 border-t font-medium">${student.name}</td>${activeClass.tasks.map(task => { const result = task.results[student.id]; let statusHtml; if (task.type === 'grade') { statusHtml = typeof result === 'number' ? result : '-'; } else { statusHtml = result ? '<span class="text-green-500">✔</span>' : '<span class="text-red-500">✖</span>'; } return `<td class="py-2 border-t text-center">${statusHtml}</td>` }).join('')}<td class="py-2 border-t text-center font-bold">${score}%</td></tr>` }).join('')}</tbody></table></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button id="print-report-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">${t('print_report')}</button><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); document.getElementById('print-report-btn').addEventListener('click', () => { const reportContent = document.getElementById('class-report-content').innerHTML; const reportTitle = `${t('class_report')}: ${activeClass.name}`; printReport(reportContent, reportTitle); }); };
        const showTaskBankModal = () => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('choose_from_bank')}</h3></div><div class="p-6 max-h-96 overflow-y-auto"><div class="space-y-2">${state.taskBank.map(template => `<div data-template-id="${template.id}" class="task-template-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-slate-100"><span>${template.name}</span><span class="text-sm text-slate-500">${t('task_weight')}: ${template.weight}</span></div>`).join('')}</div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); document.querySelectorAll('.task-template-item').forEach(item => item.addEventListener('click', (e) => { const templateId = e.currentTarget.dataset.templateId; const template = state.taskBank.find(t => t.id === templateId); if (template) { hideModal(); showAddTaskModal(template); } })); };
        const showManageTaskBankModal = () => { const content = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-content" id="manage-task-bank-modal-content"><div class="p-6 border-b"><h3 class="text-lg font-semibold">${t('manage_task_bank')}</h3></div><div id="task-bank-list" class="p-6 max-h-96 overflow-y-auto"></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl modal-buttons"><button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">${t('cancel')}</button></div></div>`; showModal(content); renderManageTaskBankModal(); };
        const renderManageTaskBankModal = () => { const container = document.getElementById('task-bank-list'); if (!container) return; container.innerHTML = `<div class="space-y-2">${state.taskBank.map(template => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-md"><div><p>${template.name}</p><p class="text-xs text-slate-500">${template.type === 'grade' ? `${t('grade_based')} (${t('max_grade')}: ${template.maxGrade})` : t('completion_based')} / ${t('task_weight')}: ${template.weight}</p></div><button data-template-id="${template.id}" class="delete-template-btn p-1 text-slate-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button></div>`).join('')}</div><form id="add-template-form" class="mt-6 pt-6 border-t"><h4 class="font-semibold mb-2">${t('add_template')}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="space-y-2"><div><label class="block text-sm font-medium text-slate-700 mb-1">${t('evaluation_type')}</label><select id="template-type" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"><option value="completion">${t('completion_based')}</option><option value="grade">${t('grade_based')}</option></select></div><div id="template-max-grade-container" class="hidden"><label class="block text-sm font-medium text-slate-700 mb-1">${t('max_grade')}</label><input type="number" id="template-max-grade" value="20" min="1" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></div></div><div class="space-y-2"><div><label class="block text-sm font-medium text-slate-700 mb-1">${t('template_name')}</label><input type="text" id="template-name" placeholder="${t('template_name')}" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div><div><label class="block text-sm font-medium text-slate-700 mb-1">${t('task_weight')}</label><input type="number" id="template-weight" value="1" min="1" max="5" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required></div></div></div><div class="text-right mt-4"><button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">${t('save')}</button></div></form>`; document.getElementById('template-type').addEventListener('change', (e) => { document.getElementById('template-max-grade-container').classList.toggle('hidden', e.target.value !== 'grade'); }); document.querySelectorAll('.delete-template-btn').forEach(btn => btn.addEventListener('click', (e) => { const templateId = e.currentTarget.dataset.templateId; const template = state.taskBank.find(t => t.id === templateId); showConfirmationModal(t('confirm_delete', template.name), () => deleteTaskTemplate(templateId)); })); document.getElementById('add-template-form').addEventListener('submit', (e) => { e.preventDefault(); const templateData = { name: document.getElementById('template-name').value.trim(), weight: Number(document.getElementById('template-weight').value), type: document.getElementById('template-type').value, }; if (templateData.type === 'grade') { templateData.maxGrade = Number(document.getElementById('template-max-grade').value); } if (templateData.name) { addTaskTemplate(templateData); } }); };
        const printReport = (reportContentHtml, reportTitle) => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="${state.language}">
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTitle}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 1.5rem; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                        th { background-color: #f8fafc; }
                    </style>
                </head>
                <body>
                    <h1 class="text-2xl font-bold mb-6">${reportTitle}</h1>
                    ${reportContentHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        };

        // ===================================================================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // ===================================================================================
        const init = () => { 
            loadState(); 
            document.getElementById('add-class-btn').addEventListener('click', showAddClassModal);
            document.getElementById('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importData(file);
                }
                e.target.value = null; // Reset input
            });
            render(); 
        };
        init();
    </script>

</body>
</html>
